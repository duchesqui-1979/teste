<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Área de Upload de Fotos</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, onSnapshot, deleteDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis globais para configuração do Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;
        let selectedPhotos = new Set();
        let allPhotos = [];

        // Função para inicializar o Firebase e autenticar
        const initFirebaseAndAuth = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Autenticação
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser?.uid || crypto.randomUUID();
                
                console.log("Firebase e autenticação inicializados com sucesso.");
                
                // Exibe o ID do usuário para fins de colaboração
                document.getElementById('user-id-display').textContent = `ID do Usuário: ${userId}`;
            } catch (error) {
                console.error("Erro ao inicializar Firebase ou autenticar:", error);
            }
        };

        window.onload = initFirebaseAndAuth;

        // Lógica de Autenticação e Upload
        const loginForm = document.getElementById('login-form');
        const uploadArea = document.getElementById('upload-area');
        const adminArea = document.getElementById('admin-area');
        const loginButton = document.getElementById('login-button');
        const uploadButton = document.getElementById('upload-button');
        const photoInput = document.getElementById('photo-input');
        const messageBox = document.getElementById('message-box');
        const closeMessage = document.getElementById('close-message');
        const messageText = document.getElementById('message-text');
        const photoAdminGallery = document.getElementById('photo-admin-gallery');
        const deleteSelectedButton = document.getElementById('delete-selected-button');
        const selectAllCheckbox = document.getElementById('select-all-photos');

        // Lógica de gerenciar playlist de vídeo
        const playlistUrlInput = document.getElementById('playlist-url');
        const savePlaylistBtn = document.getElementById('save-playlist-btn');
        const removePlaylistBtn = document.getElementById('remove-playlist-btn');
        const currentPlaylistUrlSpan = document.getElementById('current-playlist-url');


        let isLoggedIn = false;

        // Simulação de login
        loginButton.addEventListener('click', () => {
            loginForm.classList.add('hidden');
            uploadArea.classList.remove('hidden');
            adminArea.classList.remove('hidden');
            isLoggedIn = true;
            showMessage('Login simulado com sucesso!', 'success');
            setupAdminPhotoListener();
            setupPlaylistListener();
        });

        // Lidar com o upload de fotos (agora com Base64 e verificação de tamanho)
        uploadButton.addEventListener('click', async () => {
            if (!isLoggedIn) {
                showMessage('Você precisa fazer login para enviar fotos.', 'error');
                return;
            }

            const files = photoInput.files;
            if (files.length === 0) {
                showMessage('Por favor, selecione uma ou mais fotos.', 'error');
                return;
            }

            uploadButton.disabled = true;
            uploadButton.textContent = 'Enviando...';

            try {
                // CORRIGIDO: Salvando na coleção pública
                const photosCollection = collection(db, `artifacts/${appId}/public/data/photos`);
                
                const uploadPromises = Array.from(files).map(file => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                            // Limite do Firestore por documento (1MB)
                            if (e.target.result.length > 1024 * 1024) { 
                                reject(new Error(`A imagem "${file.name}" é muito grande. O limite é de 1MB por foto.`));
                                return;
                            }
                            const newPhoto = {
                                imageUrl: e.target.result,
                                caption: file.name,
                                timestamp: serverTimestamp()
                            };
                            try {
                                await addDoc(photosCollection, newPhoto);
                                resolve();
                            } catch (error) {
                                reject(error);
                            }
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                });

                await Promise.all(uploadPromises);

                photoInput.value = '';
                showMessage(`${files.length} foto(s) enviada(s) com sucesso!`, 'success');
            } catch (e) {
                console.error("Erro ao adicionar documento: ", e);
                showMessage(e.message || 'Erro ao enviar a(s) foto(s). Verifique o tamanho das imagens.', 'error');
            } finally {
                uploadButton.disabled = false;
                uploadButton.textContent = 'Enviar Fotos';
            }
        });

        // Listener para buscar as fotos do Firestore para a área de administração
        const setupAdminPhotoListener = () => {
            // CORRIGIDO: Buscando na coleção pública
            const photosCollectionRef = collection(db, `artifacts/${appId}/public/data/photos`);

            onSnapshot(photosCollectionRef, (snapshot) => {
                allPhotos = [];
                photoAdminGallery.innerHTML = '';
                if (snapshot.empty) {
                    photoAdminGallery.innerHTML = '<p class="text-center text-gray-500 w-full">Nenhuma foto para exibir. Envie a primeira!</p>';
                } else {
                    snapshot.forEach(doc => {
                        allPhotos.push({ id: doc.id, ...doc.data() });
                        const photo = { id: doc.id, ...doc.data() };
                        const photoDiv = document.createElement('div');
                        photoDiv.className = 'w-64 p-4 bg-white rounded-xl shadow-lg flex flex-col items-center justify-between';
                        photoDiv.innerHTML = `
                            <div class="flex items-center space-x-2 mb-2 w-full">
                                <input type="checkbox" data-id="${photo.id}" class="photo-checkbox rounded text-blue-600 focus:ring-blue-500">
                                <span class="flex-grow text-sm text-gray-700 truncate">${photo.caption}</span>
                            </div>
                            <img src="${photo.imageUrl}" alt="${photo.caption}" class="w-full h-32 object-cover rounded-lg mb-2">
                            <button data-id="${photo.id}" class="delete-individual-btn w-full mt-2 px-4 py-2 text-sm font-semibold text-white bg-red-600 rounded-lg shadow-md hover:bg-red-700 transition-colors">
                                Excluir
                            </button>
                        `;
                        photoAdminGallery.appendChild(photoDiv);
                    });
                }
                updateDeleteSelectedButtonState();
            });
        };

        // Lógica de exclusão individual
        photoAdminGallery.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-individual-btn')) {
                const photoId = e.target.dataset.id;
                try {
                    // CORRIGIDO: Excluindo da coleção pública
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/photos`, photoId));
                    showMessage('Foto excluída com sucesso!', 'success');
                } catch (e) {
                    console.error("Erro ao excluir documento: ", e);
                    showMessage('Erro ao excluir a foto.', 'error');
                }
            }
        });

        // Lógica de seleção e exclusão em massa
        photoAdminGallery.addEventListener('change', (e) => {
            if (e.target.classList.contains('photo-checkbox')) {
                const photoId = e.target.dataset.id;
                if (e.target.checked) {
                    selectedPhotos.add(photoId);
                } else {
                    selectedPhotos.delete(photoId);
                }
                updateDeleteSelectedButtonState();
            }
        });

        selectAllCheckbox.addEventListener('change', (e) => {
            const isChecked = e.target.checked;
            const checkboxes = document.querySelectorAll('.photo-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
                if (isChecked) {
                    selectedPhotos.add(checkbox.dataset.id);
                } else {
                    selectedPhotos.delete(checkbox.dataset.id);
                }
            });
            updateDeleteSelectedButtonState();
        });

        deleteSelectedButton.addEventListener('click', async () => {
            if (selectedPhotos.size === 0) {
                showMessage('Nenhuma foto selecionada para exclusão.', 'error');
                return;
            }
            
            try {
                const deletePromises = Array.from(selectedPhotos).map(photoId => {
                    // CORRIGIDO: Excluindo da coleção pública
                    return deleteDoc(doc(db, `artifacts/${appId}/public/data/photos`, photoId));
                });
                await Promise.all(deletePromises);
                showMessage(`${selectedPhotos.size} foto(s) excluída(s) com sucesso!`, 'success');
                selectedPhotos.clear();
                selectAllCheckbox.checked = false;
                updateDeleteSelectedButtonState();
            } catch (e) {
                console.error("Erro ao excluir fotos selecionadas: ", e);
                showMessage('Erro ao excluir as fotos selecionadas.', 'error');
            }
        });

        // Atualiza o estado do botão de exclusão em massa
        const updateDeleteSelectedButtonState = () => {
            deleteSelectedButton.disabled = selectedPhotos.size === 0;
            deleteSelectedButton.classList.toggle('opacity-50', selectedPhotos.size === 0);
            deleteSelectedButton.textContent = `Excluir Selecionadas (${selectedPhotos.size})`;
        };
        
        // Função para extrair o playlist ID da URL
        function getPlaylistId(url) {
            try {
                const urlParams = new URLSearchParams(new URL(url).search);
                return urlParams.get('list');
            } catch (e) {
                return null;
            }
        }

        const setupPlaylistListener = () => {
            const playlistDocRef = doc(db, `artifacts/${appId}/public/data/playlists`, 'current_playlist');
            onSnapshot(playlistDocRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    const url = `https://www.youtube.com/playlist?list=${data.playlistId}`;
                    currentPlaylistUrlSpan.textContent = url;
                    currentPlaylistUrlSpan.classList.remove('text-gray-500');
                    currentPlaylistUrlSpan.classList.add('text-gray-800');
                    removePlaylistBtn.classList.remove('hidden');
                } else {
                    currentPlaylistUrlSpan.textContent = 'Nenhuma playlist salva.';
                    currentPlaylistUrlSpan.classList.add('text-gray-500');
                    removePlaylistBtn.classList.add('hidden');
                }
            });
        };
        
        // Lógica para salvar a playlist no Firestore
        savePlaylistBtn.addEventListener('click', async () => {
            const url = playlistUrlInput.value;
            const playlistId = getPlaylistId(url);
            if (!playlistId) {
                showMessage('URL de playlist inválida.', 'error');
                return;
            }

            try {
                // Salva o ID da playlist em um documento público no Firestore
                const playlistDocRef = doc(db, `artifacts/${appId}/public/data/playlists`, 'current_playlist');
                await setDoc(playlistDocRef, { playlistId: playlistId });
                showMessage('Playlist salva com sucesso!', 'success');
                playlistUrlInput.value = '';
            } catch (e) {
                console.error("Erro ao salvar a playlist: ", e);
                showMessage('Erro ao salvar a playlist. Tente novamente.', 'error');
            }
        });

        // Lógica para remover a playlist do Firestore
        removePlaylistBtn.addEventListener('click', async () => {
            if (!confirm('Tem certeza que deseja remover a playlist?')) return;
            try {
                const playlistDocRef = doc(db, `artifacts/${appId}/public/data/playlists`, 'current_playlist');
                await deleteDoc(playlistDocRef);
                showMessage('Playlist removida com sucesso!', 'success');
            } catch (e) {
                console.error("Erro ao remover a playlist: ", e);
                showMessage('Erro ao remover a playlist. Tente novamente.', 'error');
            }
        });

        // Função para mostrar mensagens de feedback
        function showMessage(text, type) {
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
            if (type === 'success') {
                messageBox.classList.remove('bg-red-500');
                messageBox.classList.add('bg-green-500');
            } else if (type === 'error') {
                messageBox.classList.remove('bg-green-500');
                messageBox.classList.add('bg-red-500');
            }
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000); // Esconde a mensagem após 5 segundos
        }

        closeMessage.addEventListener('click', () => {
            messageBox.classList.add('hidden');
        });
    </script>

    <!-- UI Principal -->
    <main class="container mx-auto p-4 md:p-8">
        <section id="area-upload" class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-center text-gray-900 mb-6">Painel Administrativo</h2>
            
            <div class="p-6 bg-gray-100 rounded-xl shadow-inner max-w-xl mx-auto mb-8">
                <h3 class="text-xl font-bold mb-4 text-gray-700">Login para enviar fotos</h3>
                <p id="user-id-display" class="mb-4 text-sm text-gray-500"></p>

                <!-- Formulário de Login (Simulado) -->
                <div id="login-form">
                    <p class="text-sm text-gray-600 mb-4">Para enviar e gerenciar conteúdo, você precisa estar autenticado.</p>
                    <button id="login-button" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">
                        Simular Login
                    </button>
                </div>

                <!-- Área de Gerenciamento de Playlist (Visível após o login) -->
                <div id="admin-area" class="hidden">
                    <h3 class="text-xl font-bold text-gray-700 mb-4">Gerenciar Playlist de Vídeos</h3>
                    <div class="mb-4">
                        <p class="text-sm font-medium text-gray-700">Playlist atual:</p>
                        <p id="current-playlist-url" class="text-sm text-gray-500 break-all"></p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="playlist-url" placeholder="Insira a nova URL da playlist" class="flex-grow p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <button id="save-playlist-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                            Salvar
                        </button>
                        <button id="remove-playlist-btn" class="hidden px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition-colors">
                            Remover
                        </button>
                    </div>

                    <!-- Área de Upload de Fotos (Visível após o login) -->
                    <div id="upload-area" class="mt-8">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">Enviar Fotos para a Galeria</h3>
                        <label for="photo-input" class="block text-sm font-medium text-gray-700 mb-2">Selecione uma ou mais fotos para enviar (limite de 1MB por foto):</label>
                        <div class="flex items-center space-x-4">
                            <input type="file" id="photo-input" accept="image/*" multiple class="flex-grow p-2 border border-gray-300 rounded-lg">
                            <button id="upload-button" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors">
                                Enviar Fotos
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-8">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-700">Fotos Enviadas</h3>
                            <div class="flex items-center space-x-4">
                                <label class="flex items-center space-x-2 text-sm text-gray-700">
                                    <input type="checkbox" id="select-all-photos" class="rounded text-blue-600 focus:ring-blue-500">
                                    <span>Selecionar Todas</span>
                                </label>
                                <button id="delete-selected-button" disabled class="px-4 py-2 text-sm font-semibold text-white bg-red-600 rounded-lg shadow-md hover:bg-red-700 disabled:opacity-50 transition-colors">
                                    Excluir Selecionadas (0)
                                </button>
                            </div>
                        </div>
                        <div id="photo-admin-gallery" class="flex flex-wrap gap-4 justify-center">
                            <p class="text-center text-gray-500 w-full">Carregando fotos...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-8 flex justify-center">
                <a href="escola-legislativo-site.html" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                    Voltar para a Galeria
                </a>
            </div>
        </section>
    </main>

    <!-- Caixa de Mensagem (Toast) -->
    <div id="message-box" class="hidden fixed bottom-4 right-4 z-50 p-4 rounded-xl shadow-xl text-white max-w-sm">
        <div class="flex justify-between items-center">
            <p id="message-text" class="mr-4"></p>
            <button id="close-message" class="text-white opacity-70 hover:opacity-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>
</body>
</html>
